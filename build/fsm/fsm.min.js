var __reflect=this&&this.__reflect||function(t,n,i){t.__class__=n,i?i.push(n):i=[n],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(){var t=function(n,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])})(n,i)};return function(n,i){function e(){this.constructor=n}if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");t(n,i),n.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)}}(),fsm;!function(t){var n=function(){function t(t){this.needsExitTimes=t}return t.prototype.init=function(){},t.prototype.onEnter=function(){},t.prototype.onLogic=function(){},t.prototype.onExit=function(){},t.prototype.requestExit=function(){},t}();t.StateBase=n,__reflect(n.prototype,"fsm.StateBase")}(fsm||(fsm={}));var fsm;!function(t){var n=function(n){function e(t){void 0===t&&(t=!0);var i=n.call(this,t)||this;return i.startState={hasState:!1,state:null},i.pendingState={isPending:!1,state:null},i.nameToStateBundle=new Map,i._activeState=null,i.activeTransitions=e.noTranstions,i.activeTriggerTransitions=e.noTriggerTranstions,i.transitionsFromAny=[],i.triggerTransitionsFromAny=new Map,i}return __extends(e,n),Object.defineProperty(e.prototype,"activeStateName",{get:function(){return this.activeState.name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isRootFsm",{get:function(){return!this.fsm},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"activeState",{get:function(){if(!this._activeState)throw new t.exceptions.StateMachineNotInitializedException("Trying to get the active state");return this._activeState},enumerable:!1,configurable:!0}),e.prototype.stateCanExit=function(){var t,n=this.pendingState;n.isPending&&(this.changeState(n.state),n.state=!1),null===(t=this.fsm)||void 0===t?void 0:t.stateCanExit()},e.prototype.requestExit=function(){var t;return this.activeState.needsExitTimes?void this.activeState.requestExit():void(null===(t=this.fsm)||void 0===t?void 0:t.stateCanExit())},e.prototype.requestStateChange=function(t,n){!this.activeState.needsExitTimes||n?this.changeState(t):(this.pendingState.state=t,this.pendingState.isPending=!0,this.activeState.requestExit())},e.prototype.setStartState=function(t){this.startState.state=t,this.startState.hasState=!0},e.prototype.init=function(){this.isRootFsm&&this.onEnter()},e.prototype.onEnter=function(){if(!this.startState.hasState)throw new Error(t.exceptions.ExceptionFormatter.format("Running OnEnter of the state machine.","No start state is selected. \n                        'The state machine needs at least one state to function properly.","Make sure that there is at least one state in the state machine \n                         before running Init() or OnEnter() by calling fsm.AddState(...)."));this.changeState(this.startState.state),this.transitionsFromAny.forEach(function(t){t.onEnter()}),this.triggerTransitionsFromAny.forEach(function(t){t.forEach(function(t){t.onEnter()})})},e.prototype.onLogic=function(){if(!this.activeState)throw new t.exceptions.StateMachineNotInitializedException("running onlogic");for(var n=this,i=n.transitionsFromAny,e=n.activeTransitions,o=i.length,r=0;o>r;r++){var a=i[r];if(a.to!=this.activeState.name&&this.tryTransition(a))break}o=e.length;for(var r=0;o>r;r++){var a=e[r];if(this.tryTransition(a))break}this.activeState.onLogic()},e.prototype.onExit=function(){this.activeState&&(this.activeState.onExit(),this._activeState=null)},e.prototype.addState=function(n,i,e,o,r,a){if(i instanceof t.StateBase){i.fsm=this,i.name=n,i.init();var s=this.getOrCreateStateBundle(n);s.state=i,1!==this.nameToStateBundle.size||this.startState.hasState||this.setStartState(n)}else{if(!(i||e||o||r))return void this.addState(n,new t.StateBase(a));this.addState(n,new t.State(i,e,o,r,a))}},e.prototype.addTransition=function(n,i,e,o){if(void 0===e&&(e=null),void 0===o&&(o=!1),n instanceof t.TransitionBase){this.initTransition(n);var r=this.getOrCreateStateBundle(n.from);r.addTransition(n)}else this.addTransition(this.createOptimizedTransition(null,i,e,o))},e.prototype.addTransitionFromAny=function(n,i,e){void 0===i&&(i=null),void 0===e&&(e=!1),n instanceof t.TransitionBase?(this.initTransition(n),this.transitionsFromAny.push(n)):this.addTransitionFromAny(this.createOptimizedTransition(null,n,i,e))},e.prototype.addTriggerTransition=function(n,i,e,o,r){if(i instanceof t.TransitionBase){this.initTransition(i);var a=this.getOrCreateStateBundle(i.from);return void a.addTriggerTranstion(n,i)}this.addTriggerTransition(n,this.createOptimizedTransition(i,e,o,r))},e.prototype.trigger=function(t){if(!this.tryTrigger(t)){var n=this.activeState;n.trigger&&n.trigger(t)}},e.prototype.triggerLocally=function(t){this.tryTrigger(t)},e.prototype.getState=function(n){var i=this.nameToStateBundle.get(n);if(!i||!i.state)throw new t.exceptions.StateNotFoundException(n,"Getting a state");return i.state},e.prototype.get=function(n){var i=this.getState(n);if(i instanceof e)return i;throw new Error(t.exceptions.ExceptionFormatter.format("Getting a nested state machine with the indexer","The selected state is not a state machine.","This method is only there for quickly accessing a nested state machine.\n                    To get the selected state, use GetState("+n+")."))},e.prototype.changeState=function(n){var i,o,r;null===(i=this.activeState)||void 0===i?void 0:i.onExit();var a=this.nameToStateBundle.get(n);if(!a||!a.state)throw new t.exceptions.StateNotFoundException(n,"Switching states");this.activeTransitions=null!==(o=a.transitions)&&void 0!==o?o:e.noTranstions,this.activeTriggerTransitions=null!==(r=a.triggerToTransitions)&&void 0!==r?r:e.noTriggerTranstions,this._activeState=a.state,this.activeState.onEnter(),this.activeTransitions.forEach(function(t){t.onEnter()}),this.activeTriggerTransitions.forEach(function(t){t.forEach(function(t){t.onEnter()})})},e.prototype.tryTransition=function(t){return t.shouldTransition()?(this.requestStateChange(t.to,t.forceInstantly),!0):!1},e.prototype.getOrCreateStateBundle=function(t){var n=this.nameToStateBundle.get(t);return n||(n=new i,this.nameToStateBundle.set(t,n)),n},e.prototype.initTransition=function(t){t.fsm=this,t.init()},e.prototype.tryTrigger=function(n){if(!this.activeState)throw new t.exceptions.StateMachineNotInitializedException("Checking all trigger transitions of the active state");var i=this.triggerTransitionsFromAny.get(n);if(i)for(var e=i.length,o=0;e>o;o++){var r=i[o];if(r.to!=this.activeState.name&&this.tryTransition(r))return!0}if(i=this.activeTriggerTransitions.get(n))for(var a=i.length,o=0;a>o;o++){var r=i[o];if(this.tryTransition(r))return!0}return!1},e.prototype.createOptimizedTransition=function(n,i,e,o){return void 0===e&&(e=null),void 0===o&&(o=!1),null==e?new t.TransitionBase(n,i,o):new t.Transition(n,i,e,o)},e.noTranstions=[],e.noTriggerTranstions=new Map,e}(t.StateBase);t.StateMachine=n,__reflect(n.prototype,"fsm.StateMachine",["fsm.ITriggerable","fsm.IStateMachine"]);var i=function(){function t(){}return t.prototype.addTransition=function(t){this.transitions||(this.transitions=[]),this.transitions.push(t)},t.prototype.addTriggerTranstion=function(t,n){this.triggerToTransitions||(this.triggerToTransitions=new Map),this.triggerToTransitions.has(t)||this.triggerToTransitions.set(t,[]),this.triggerToTransitions.get(t).push(n)},t}();__reflect(i.prototype,"StateBundle")}(fsm||(fsm={}));var fsm;!function(t){var n=function(){function t(t,n,i){void 0===i&&(i=!1),this.from=t,this.to=n,this.forceInstantly=i}return t.prototype.init=function(){},t.prototype.onEnter=function(){},t.prototype.shouldTransition=function(){return!0},t}();t.TransitionBase=n,__reflect(n.prototype,"fsm.TransitionBase")}(fsm||(fsm={}));var fsm;!function(t){var n=function(t){function n(n,i,e,o){void 0===n&&(n=null),void 0===i&&(i=null),void 0===e&&(e=null),void 0===o&&(o=!1);var r=t.call(this,o)||this;return r._enter=n,r._logic=i,r._exit=e,r.timer=Date.now(),r}return __extends(n,t),n.prototype.onEnter=function(){var n;t.prototype.onEnter.call(this),this.timer=Date.now(),null===(n=this._enter)||void 0===n?void 0:n.call(this,this)},n.prototype.onLogic=function(){t.prototype.onLogic.call(this),this._logic.call(this,this)},n.prototype.onExit=function(){t.prototype.onExit.call(this),this._logic.call(this,this)},n}(t.StateMachine);t.HybridStateMachine=n,__reflect(n.prototype,"fsm.HybridStateMachine")}(fsm||(fsm={}));var fsm;!function(t){var n=function(t){function n(n,i,e,o,r){void 0===n&&(n=null),void 0===i&&(i=null),void 0===e&&(e=null),void 0===o&&(o=null),void 0===r&&(r=!0);var a=t.call(this,r)||this;return a._onEnter=n,a._onLogic=i,a._onExit=e,a._canExit=o,a}return __extends(n,t),n.prototype.init=function(){this.timer=Date.now()},n.prototype.onEnter=function(){var t;this.timer=Date.now(),null===(t=this._onEnter)||void 0===t?void 0:t.call(this,this)},n.prototype.onLogic=function(){var t;null===(t=this._onLogic)||void 0===t?void 0:t.call(this,this)},n.prototype.onExit=function(){var t;null===(t=this._onExit)||void 0===t?void 0:t.call(this,this)},n.prototype.requestExit=function(){var t;(!this.needsExitTimes||(null===(t=this._canExit)||void 0===t?void 0:t.call(this,this)))&&this.fsm.stateCanExit()},n}(t.StateBase);t.State=n,__reflect(n.prototype,"fsm.State")}(fsm||(fsm={}));var fsm;!function(t){var n=function(){function t(t,n,i,e,o,r){void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=null),void 0===e&&(e=null),void 0===o&&(o=null),void 0===r&&(r=null),this.beforeOnEnter=t,this.afterOnEnter=n,this.beforeOnLogic=i,this.afterOnLogic=e,this.beforeOnExit=o,this.afterOnExit=r}return t.prototype.warp=function(t){return new i(t,this.beforeOnEnter,this.afterOnEnter,this.beforeOnLogic,this.afterOnLogic,this.beforeOnExit,this.afterOnExit)},t}();t.StateWrapper=n,__reflect(n.prototype,"fsm.StateWrapper");var i=function(t){function n(n,i,e,o,r,a,s){void 0===i&&(i=null),void 0===e&&(e=null),void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),void 0===s&&(s=null);var c=t.call(this,n.needsExitTimes)||this;return c.state=n,c.beforeOnEnter=i,c.afterOnEnter=e,c.beforeOnLogic=o,c.afterOnLogic=r,c.beforeOnExit=a,c.afterOnExit=s,c}return __extends(n,t),n.prototype.init=function(){var t=this,n=t.state,i=t.name,e=t.fsm;n.name=i,n.fsm=e,n.init()},n.prototype.onEnter=function(){var t,n;null===(t=this.beforeOnEnter)||void 0===t?void 0:t.call(this,this),this.state.onEnter(),null===(n=this.afterOnEnter)||void 0===n?void 0:n.call(this,this)},n.prototype.onLogic=function(){var t,n;null===(t=this.beforeOnLogic)||void 0===t?void 0:t.call(this,this),this.state.onLogic(),null===(n=this.afterOnLogic)||void 0===n?void 0:n.call(this,this)},n.prototype.onExit=function(){var t,n;null===(t=this.beforeOnExit)||void 0===t?void 0:t.call(this,this),this.state.onExit(),null===(n=this.afterOnExit)||void 0===n?void 0:n.call(this,this)},n.prototype.requestExit=function(){this.state.requestExit()},n.prototype.trigger=function(t){var n=this.state;n.trigger&&n.trigger.call(n,t)},n}(t.StateBase);__reflect(i.prototype,"WrappedState",["fsm.ITriggerable"])}(fsm||(fsm={}));var fsm;!function(t){var n=function(t){function n(n,i,e,o){void 0===e&&(e=null),void 0===o&&(o=!1);var r=t.call(this,n,i,o)||this;return r.condition=e,r}return __extends(n,t),n.prototype.shouldTransition=function(){var t;return null==this.condition?!0:null===(t=this.condition)||void 0===t?void 0:t.call(this,this)},n}(t.TransitionBase);t.Transition=n,__reflect(n.prototype,"fsm.Transition")}(fsm||(fsm={}));var fsm;!function(t){var n=function(t){function n(n,i,e,o,r){void 0===o&&(o=null),void 0===r&&(r=!1);var a=t.call(this,n,i,r)||this;return a.delay=e,a.condition=o,a.timer=Date.now(),a}return __extends(n,t),n.prototype.onEnter=function(){this.timer=Date.now()},n.prototype.shouldTransition=function(){var t,n=Date.now()-this.timer;return n<this.delay?!1:null===this.condition?!1:null===(t=this.condition)||void 0===t?void 0:t.call(this,this)},n}(t.TransitionBase);t.TransitionAfter=n,__reflect(n.prototype,"fsm.TransitionAfter")}(fsm||(fsm={}));var fsm;!function(t){var n=function(t){function n(n,i,e,o,r){void 0===o&&(o=null),void 0===r&&(r=!1);var a=t.call(this,n,i,r)||this;return a.delay=e,a.condition=o,a.timer=Date.now(),a}return __extends(n,t),n.prototype.onEnter=function(){this.timer=Date.now()},n.prototype.shouldTransition=function(){var t=Date.now()-this.timer;return t<this.delay.call(this,this)?!1:null===this.condition?!1:this.condition.call(this,this)},n}(t.TransitionBase);t.TransitionAfterDynamic=n,__reflect(n.prototype,"fsm.TransitionAfterDynamic")}(fsm||(fsm={}));var fsm;!function(t){var n;!function(t){var n=function(){function t(){}return t.format=function(t,n,i){void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=null);var e="\n";return null!=t&&(e+="Context: "+t+"\n"),null!=n&&(e+="Problem: "+n+"\n"),null!=i&&(e+="Solution: "+i+"\n"),e},t}();t.ExceptionFormatter=n,__reflect(n.prototype,"fsm.exceptions.ExceptionFormatter")}(n=t.exceptions||(t.exceptions={}))}(fsm||(fsm={}));var fsm;!function(t){var n;!function(t){var n=function(n){function i(t,e,o){return n.call(this,i.format(t,e,o))||this}return __extends(i,n),i.format=function(n,i,e){return void 0===n&&(n=null),void 0===i&&(i=null),void 0===e&&(e=null),null==i&&(i="The active state is null because the state machine has not been set up yet."),null==e&&(e="Call fsm.setStartState(...) and fsm.init() or fsm.onEnter() to initialize the state machine."),t.ExceptionFormatter.format(n,i,e)},i}(Error);t.StateMachineNotInitializedException=n,__reflect(n.prototype,"fsm.exceptions.StateMachineNotInitializedException")}(n=t.exceptions||(t.exceptions={}))}(fsm||(fsm={}));var fsm;!function(t){var n;!function(t){var n=function(n){function i(t,e,o,r){return n.call(this,i.format(t,e,o,r))||this}return __extends(i,n),i.format=function(n,i,e,o){return void 0===i&&(i=null),void 0===e&&(e=null),void 0===o&&(o=null),null==e&&(e='The state "'+n+"\" has not been defined yet / doesn't exist."),null==o&&(o="\n1. Check that there are no typos in the state names and transition from and to names\n2. Add this state before calling Init / OnEnter / OnLogic / RequestStateChange / ..."),t.ExceptionFormatter.format(i,e,o)},i}(Error);t.StateNotFoundException=n,__reflect(n.prototype,"fsm.exceptions.StateNotFoundException")}(n=t.exceptions||(t.exceptions={}))}(fsm||(fsm={}));